rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is a verified host
    function isHost(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.isVerifiedHost == true;
    }

    // USER-Collection
    // Jeder darf Profile lesen.
    // Nur der authentifizierte Benutzer darf sein eigenes Profil bearbeiten.
    // Das Erstellen von Benutzerdokumenten wird durch die createUserDocument Funktion in der App gesteuert.
    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      // Löschen von Benutzern sollte nur über eine Admin-Funktion erfolgen
      allow delete: if false; 
    }

    // EVENTS-Collection
    // Jeder darf Events lesen.
    // Nur verifizierte Hosts dürfen Events erstellen.
    // Nur der Host, dem das Event gehört, darf es bearbeiten.
    match /events/{eventId} {
      allow read: if true;
      allow create: if request.auth != null && isHost(request.auth.uid);
      allow update: if request.auth != null && request.auth.uid == resource.data.hostUid;
      // Löschen nur durch den Host oder einen Admin
      allow delete: if request.auth != null && request.auth.uid == resource.data.hostUid;
    }
    
    // CHATS-Collection
    // Lesen und Schreiben von Chat-Metadaten nur für Teilnehmer
    match /chats/{chatId} {
      allow read, update: if request.auth != null && request.auth.uid in resource.data.participantUids;
      allow create: if request.auth != null; // Jeder kann einen Chat initiieren
      
      // MESSAGES-Sub-Collection
      // Lesen und Schreiben von Nachrichten nur für Teilnehmer des Chats
      match /messages/{messageId} {
        allow read, create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantUids;
        // Nachrichten können nicht bearbeitet oder gelöscht werden
        allow update, delete: if false; 
      }
    }
  }
}
